---
title: Using New Relic Dotnet Extension Buildpack for PCF
owner: Partners
---

This topic describes how to use New Relic Dotnet Extension Buildpack for Pivotal Cloud Foundry (PCF).


## <a id='using'></a> About Using New Relic Dotnet Extension Buildpack for PCF

New Relic extension buildpacks allow you to use Dotnet agents in various ways
to make it easy and convenient to bind apps to a New Relic service.

### <a id='how-it-works'></a> How the New Relic Extension Buildpack for PCF Works

The buildpack extensions bind to the New Relic Dotnet agent using one of the following ways depending on the environment:

1. If an environment variable named **"NEW_RELIC_DOWNLOAD_URL"** is defined in the app environment 
(manifest file, cf set-env, or set in AppsMgr), its value is used as the location to download the agent. 
This is used for environments where you have your own repository for downloading dependencies (i.e. Artifactory). 
If a second environment variable called **"NEW_RELIC_DOWNLOAD_SHA256"** is set in the app environment, 
it is expected to hold the downloaded agent's binary file SHA256 checksum. 
In this case the SHA256 checksum of the downloaded agent binary file is compared with this value, and in the case of a mismatch, the buildpack reports an error.

1. You can create a cached version of the buildpack using the **"--cached"** switch with New Relic agent embedded in 
the buildpack. This is mainly used in disconnected (isolated) environments where PCF does not have access to the 
outside world, and the buildpack cannot download the agent from New Relic's download site.

1. Use a specific version of New Relic agent by specifying the version in the buildpack manifest file at the time of packaging.

1. Set the version of the agent to **"0.0.0.0"**, **"latest"**, or **"current"** in buildpack manifest file to download the latest version of the agent.

Except in the first case when the download URL is specified, and the sha-256 code is not available 
the buildpack checks the SHA256 checksum of the downloaded (or copied) agent to validate the download.

New Relic recommends you use the latest version of New Relic agents unless there is a reason
that keeps you from upgrading to newer releases of the agent.


### <a id='precedence'></a> Order of Precedence

The order of precedence for which method to use to obtain the New Relic agent is from the top to bottom:

1. If **"NEW_RELIC_DOWNLOAD_URL"** is specified, it precedes all other options. 

1. If this environment variable is not specified, the cached buildpack takes precedence. 

1. Otherwise, the `version` property of the agent in the buildpack manifest is used, 
and one of the other two options is used to download the agent, 
depending on the value of the `version` property of the agent dependency (explicit version or "latest").


## <a id='how-it-operates'></a> How the Extension Buildpack Binds Apps to the New Relic Agent

The buildpack looks for several environment variables and files to determine how to bind the app to the agent.


### <a id='license-key'></a> Bind the App to the New Relic Agent

The license key for a New Relic account must be specified in one of the following ways:<br/><br/>
* NEW_RELIC_LICENSE_KEY env var<br/>
* License key from User-Provided-Service<br/>
* License key from Service Broker Tile in Marketplace<br/>
* License key from newrelic.config<br/>

<p class="note"><strong>Note:</strong> environment variables override all other options.</p>


### <a id='app-name'></a> App Name in the New Relic UI

The app name for New Relic is determined in the following order:<br/><br/>
* NEW_RELIC_APP_NAME env var<br/>
* App name from User-Provided-Service<br/>
* App name from PCF<br/>
* **Note** Currently the App name is not used in the newrelic.config file<br/>


### <a id='agent-config'></a> New Relic Agent Configuration File

The New Relic configuration file (**"newrelic.config"**) allows you to set a number of agent properties and change the behavior of the agent as you wish. 
Refer to [.NET agent configuration](https://docs.newrelic.com/docs/agents/net-agent/configuration/net-agent-configuration) 
for more information on configuring the agent. You can make a copy of this file in the app's root directory, and change any of agent's settings. 
The buildpack looks for the agent's config file in the following order:<br/><br/>
* App root folder<br/>
* Buildpack folder<br/>
* Agent folder<br/>


### <a id='ups'></a> New Relic User-Provided-Services

If the app binds to a User-Provided-Service with the word **"newrelic"** as part of its name, 
the buildpack injects the credentials from this service in the app environment by setting environment 
variable for known New Relic properties. The known properties currently are:<br/><br/>
* NEW_RELIC_LICNESE_KEY<br/>
* NEW_RELIC_APP_NAME<br/>
* NEW_RELIC_DISTRIBUTED_TRACING_ENABLED<br/>


### <a id='proxy'></a> Use of Proxy

If you're using a proxy server in your environment, you need to make a copy of the **"newrelic.config"** 
file of the agent in the app directory, 
and specify the [proxy information](https://docs.newrelic.com/docs/agents/net-agent/configuration/net-agent-configuration#proxy) 
as a child of the **&lt;service&gt;** element.<br/>
**Example:**<br/>
<pre>
	&lt;service licenseKey="0123456789abcdef0123456789abcdef01234567"&gt;
	  &lt;proxy name="my.proxy.address" port="proxy.port" /&gt;
	&lt;/service&gt;
</pre>


## <a id='tips-tricks'></a>Tips and Tricks

### <a id='using-nr-agent'></a>Using the New Relic Agent

You need to specify a New Relic account **license key** in one of the following ways in order to bind your app to the New Relic service:

* **Bind your application to New Relic using a License Key**

The quickest and easiest way to bind your app to the New Relic Dotnet agent is
using the license key environment variable (**"NEW_RELIC_LICNENSE_KEY"**) and
set it using your New Relic account license key.


* **Bind your application to a local copy of New Relic Dotnet Agent**
<br/>
If you are in a disconnected (isolated) environment, the easiest way is to obtain the latest version of New Relic Dotnet 
agent(s) is through the [New Relic download site](http://download.newrelic.com/dot_net_agent/). You can then upload them to your 
local repository (i.e. Artifactory). In the app's manifest file you can then set the **"NEW_RELIC_DOWNLOAD_URL"** environment variable to the  location of the agent download.


* **Bind your application to New Relic using the Agent tile in the Marketplace**
	
	* From Marketplace:
		- Click on New Relic Dotnet Extension Buildpack for PCF tile
		- Select the plan that is associated with your New Relic account (check with PCF admin)
		- Specify the instance name
		- If you already have the app running on PCF you could specify the app name as well. Otherwise, once you push the app, you can directly bind to an existing service instance (or create a new service instance) from the app UI
		- Click the **CREATE** button to create the service instance

		- Once the service instance is created, you can also use the "services" stanza in your app manifest.yml file, and specify the name of the service you just created in the marketplace
		- Restage the app using **"cf restage YOUR_APPNAME"** from the command line


	* From "Services" tab of the app in Apps Manager
		- Push your app to PCF
		- In Apps Manager click on your app
		- Go to the "Services" tab of your app
		- If you have already created a service instance:
			- Select "BIND SERVICE".
			- Select the desired service instance from the list
			- Click "BIND"
		- If you have not created any service instances, and this is the first time:
			- Select "NEW SERVICE"
			- Click on the New Relic Dotnet Extension Buildpack for PCF service tile
			- Select the plan that is associated with your New Relic account
			- Click "SELECT PLAN" button
			- Specify the instance name
			- Click "CREATE"
		- "Restage" the app using **"cf restage YOUR_APPNAME"** from the command line


* **Bind your application to New Relic using User-Provided-Service**

	- Create a User-Provided-Service with the word "newrelic" embedded as part of the service name 
	- Add the following credentials to the user-rpovided-service:
		- "licenseKey" This is New Relic License Key - **REQUIRED**
		- "appName"    If you want to change the app name in New Relic use this property - **OPTIONAL**
		- Sample CUPS command: ```cf cups my-newrelic-svc -p "licenseKey,appName"```
			- You will be prompted to provide values for licenseKey and appName<br/>
	- Push your app in one of the following ways:
		- By adding the User-Provided-Service to the app manifest.yml before pushing the app
		- By adding the User-Provided-Service in the Apps Manager by binding an existing service instance, and restaging it after you bind the service


* **Bind your application to New Relic using CF CLI**
	- Create an instance of New Relic service:
		<pre>
			cmd: cf create-service newrelic &lt;NEWRELIC_PLAN_NAME&gt; &lt;YOUR_NEWRELIC_SERVICE_INSTANCE_NAME&gt;
		</pre>
	- Specify the newly created service instnace name in the **"services"** section of the app manifest (indented by two spaces):
		<pre>
			  services:
			  - YOUR_NEWRELIC_SERVICE_INSTANCE_NAME
		</pre>
	- Push the app
		<pre>
			cmd: cf push<br/>
		</pre>

<br/>

### <a id='envvar-and-nrconfig'></a>Using Environment Variables and Agent Configuration

* You can use a combination of the "newrelic.config" file and/or environment variables to configure the 
New Relic Dotnet agent to report your app's health and performance to the designated New Relic account.

	- A copy of the 'newrelic.config' file is provided with the buildpack. 
If you need to add any agent features such as proxy settings, or change any other agent settings like logging behavior, 
download the **newrelic.config** file from New Relic, place it the app folder, 
and edit as required. You can refer to [New Relic Configuration documentation](https://docs.newrelic.com/docs/agents/net-agent/configuration/net-agent-configuration) for details on what properties are available. The following are some examples you can use:

		- **new relic license key:** Add your New Relic license key:<br/>
			```
			  <service licenseKey="0123456789abcdef0123456789abcdef01234567">
			```

			Alternatively, you can add the license key to app's 'manifest.yml' file as an environment variable "NEW_RELIC_LICENSE_KEY" in the "env" section

	
		- **New Relic app name:** If you want the app name in New Relic be different than the app name in PCF, add the New Relic app name as you'd like it to appear in New Relic<br/>
	    <pre>
			  &lt;application&gt;
			    &lt;name&gt;My Application&lt;/name&gt;
			  &lt;/application&gt;
	    </pre>

			Alternatively you can add the New Relic app name to the app's 'manifest.yml' file as an environment variable "NEW_RELIC_APP_NAME" in the "env" section
		

	    - **Proxy Setting:** Add proxy settings to the "service" element as a sub-element. **Example:**
	    <pre>
	    	  &lt;service licenseKey="0123456789abcdef0123456789abcdef01234567"&gt;
	    	    &lt;proxy host="my_proxy_server.com" port="9090" /&gt;
	    	  &lt;/service&gt;
	    </pre>

		

	    - **Logging Level:** Change agent logging level and destination<br/>
	    <pre>
	    	  &lt;log level="info" console="true" /&gt;
	    </pre>
		
	    - **Non-IIS Executable Instrumentation:** Since for Dotnet Framework apps 'hwc.exe' is the executable 
running your app, the copy of **"newrelic.config"** file that comes with the hwc extension 
contains the proper settings to tell the executable name to the agent. 
If you provide your own **"newrelic.config"** file, make sure it contains the following tag:
	    <pre>
			  &lt;instrumentation&gt;
			    &lt;applications&gt;
			      &lt;application name="hwc.exe" /&gt;
			    &lt;/applications&gt;
			  &lt;/instrumentation&gt;
		</pre>
	    
            <p class="note"><strong>Note:</strong> Depending on your CI/CD pipeline,
               the app directory may be created on-the-fly as part of the on-the-fly as part of the
               pipeline. If that is the case and you are modifying this file,
               your pipeline need to copy over the file to the app directory before pushing the app to PCF.</p>

	
	- Push your application to PCF using this buildpack.
          To do that, edit your manifest.yml and add/update the following entry.

		<pre>
			buildpacks:
			- &lt;NEWRELIC_EXTENSION_BUILDPACK_NAME&gt;
			- hwc_buildpack
		</pre>

		Then run "cf push".

		**Note:** If you use Bamboo as your CI/CD pipeline tool, the "cf push" may not be required as your pipeline internally uses "cf push" to push the app to PCF.



### <a id='envvar-and-nrconfig'></a>Debugging

* Set the **BP_DEBUG** environment variable
	- For troubleshooting purposes, you can set **BP_DEBUG** environment variable in your app environment to get more logging during the app push.


* Check the logs
	- Use **cf logs &lt;APP_NAME&gt;** or **cf logs &lt;APP_NAME&gt; --recent**   to examine the app logs. It should display New Relic agent installation progress.


* Use Cloud Foundry's [**CF_TRACE**](https://docs.cloudfoundry.org/devguide/deploy-apps/troubleshoot-app-health.html#trace-cloud-controller-rest-api-calls) to get detailed information about errors and unexpected behavior.


## <a id='examples'></a>Examples

### <a id='example-dotnet-core'></a>Push a Sample Dotnet Core App to PCF

This example does the following:

+ Uses the `dotnet` CLI to create a sample Dotnet Core app
+ Configures the app manifest to bind the app with New Relic Dotnet Core agent
+ Pushes the app to PCF. 

The example uses environment variables to specify the license key for the New Relic account.

1. Create a sample Dotnet MVC app or use your existing Dotnet Core app.

    ```
    dotnet new mvc -n myapp
    ```

1. Test the app locally<br/>
```
cd myapp
dotnet run
```

1. Create a manifest.yml file for the app<br/>
  <pre>---
applications:
\- name: myapp
&nbsp; memory: 256M
&nbsp; buildpacks:
&nbsp;   \- nr\_dotnetcore\_extension\_buildpack
&nbsp;   \- dotnet\_core\_buildpack
&nbsp; env:
&nbsp;   NEW\_RELIC\_LICENSE\_KEY: 0123456789abcdef0123456789abcdef01234567
  </pre>

1. To push the app to PCF, run the `cf push` command.


### <a id='example-dotnet-framework'></a>Push a Sample Dotnet Framework App to PCF

The following example shows the steps to configure the app manifest to bind a Dotnet Framework app to the 
New Relic Dotnet Framework agent using the New Relic HWC extension buildpack and the standard Cloud Foundry
HWC buildpack and to push the app to PCF.

The example uses environment variable to specify the license key for the New Relic account. 

1. Create a sample Dotnet Framework app or pick one of your Dotnet Framework apps.

1. Test the app locally and make sure it runs with no errors.

1. Create a `manifest.yml` file for the app.
  <pre>---
applications:
\- name: myapp
&nbsp; memory: 256M  # adjust as needed
&nbsp; buildpacks:
&nbsp;   \- nr\_hwc\_extension_buildpack
&nbsp;   \- hwc\_buildpack
&nbsp; env:
&nbsp;   NEW\_RELIC\_LICENSE\_KEY: 0123456789abcdef0123456789abcdef01234567
  </pre>

1. To push the app to PCF, run the `cf push` command.
